<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>项目信息详情</title>
    <link rel="stylesheet" href="/css/project/detail.css">
</head>
<body>

    <form class="layui-form">
        
        <input type="hidden" name="projectId" id="projectId">

        <div class="title">
            <div class="content">
                <h1 id="type"></h1>
                <div class="btns">
                    <button class="layui-btn layui-btn-sm" lay-submit lay-filter="sub-project">保存</button>
                    <a class="layui-btn layui-btn-primary layui-btn-sm" href="/html/project/list.html">返回</a>
                </div>
            </div>
        </div>

        <div class="main">
            
            <blockquote class="layui-elem-quote">基本信息</blockquote>
            <div class="layui-row layui-col-space10 x-city" id="location">
                <div class="layui-col-md4">
                    <label class="layui-form-label required">工程名称</label>
                    <div class="layui-col-md8">
                        <input type="text" name="projectName" id="projectName" required lay-verify="required" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label required">工程编号</label>
                    <div class="layui-col-md8">
                        <input type="text" name="projectNo" id="projectNo" required lay-verify="required" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">合同编号</label>
                    <div class="layui-col-md8">
                        <input type="text" name="contractNo" id="contractNo" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">甲方名称（合同甲方）</label>
                    <div class="layui-col-md8">
                        <input type="text" name="companyName" id="companyName" autocomplete="off" class="layui-input">
                        <button class="layui-btn layui-btn-sm" lay-filter="add-company">新增</button>
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">甲方集团名称</label>
                    <div class="layui-col-md8">
                        <input type="text" name="groupName" id="groupName" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">合同签订时间</label>
                    <div class="layui-col-md8">
                        <input type="text" name="signDate" id="signDate" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">开工时间（约定）</label>
                    <div class="layui-col-md8">
                        <input type="text" name="startDate" id="startDate" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">竣工时间（约定）</label>
                    <div class="layui-col-md8">
                        <input type="text" name="endDate" id="endDate" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">历时（月）</label>
                    <div class="layui-col-md8">
                        <input type="number" name="months" id="months" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">合同总价</label>
                    <div class="layui-col-md8">
                        <input type="number" name="totalPrice" id="totalPrice" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">区域总</label>
                    <div class="layui-col-md8">
                        <input type="hidden" name="generalManager" id="generalManager">
                        <div class="emp" id="emp_gm"></div>
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">项目经理</label>
                    <div class="layui-col-md8">
                        <input type="hidden" name="manager" id="manager">
                        <div class="emp" id="emp_m"></div>
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">项目所在地（省）</label>
                    <div class="layui-col-md8">
                        <select name="province" lay-filter="province">
                            <option value="">请选择省</option>
                        </select>
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">项目所在地（市）</label>
                    <div class="layui-col-md8">
                        <select name="city" lay-filter="city">
                            <option value="">请选择市</option>
                        </select>
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">项目状态</label>
                    <div class="layui-col-md8">
                        <select name="status" id="status" lay-filter="status">
                            <option value="1">待进场</option>
                            <option value="2">施工中</option>
                            <option value="3">停工中</option>
                            <option value="4">已完工</option>
                        </select>
                    </div>
                </div>
                
            </div>




            <blockquote class="layui-elem-quote">项目部填写信息</blockquote>
            <div class="layui-row layui-col-space10">
                <div class="layui-col-md4">
                    <label class="layui-form-label">工程结构类型</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">建筑面积（㎡）</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">实际进场时间</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">预计/实际完工时间</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">项目所在地定位</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">项目状态</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">总形象进度</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">风险情况简述</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">增补合同价</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">含增补合同总价</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">结算总价（元）</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">保修金占比</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">保修金金额（元）</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">保修期限</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">《结算协议》扫描件</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">《竣工验收单》扫描件</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                
            </div>



            <blockquote class="layui-elem-quote">财务部填写项目盈亏分析</blockquote>
            <div class="layui-row layui-col-space10">
                <div class="layui-col-md4">
                    <label class="layui-form-label">区域财务</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">已开发票合计</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">甲方付款合计</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">现金收款合计</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">供应链收款合计</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">其他收入合计</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">已付工资合计</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">工人支款合计</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">管理费合计</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">包工工资合计</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">税金合计</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">项目报销费用总金额</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">其他费用合计</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">材料入库金额合计</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">财务信息更新日期</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md4">
                    <label class="layui-form-label">备注</label>
                    <div class="layui-col-md8">
                        <input type="text" name="title" autocomplete="off" class="layui-input">
                    </div>
                </div>
                
            </div>
        </div>
    </form>
        
</body>
<script src="/js/config.js"></script>
<script src="/js/common.js"></script>
<script src="/js/jquery-3.4.1.min.js"></script>
<script src="/lib/layui/layui.js"></script>
<script type="text/html" id="eList-tpl">

    <div class="layui-row" style="margin-bottom: 0;padding: 10px;box-sizing: border-box;">
        <div class="layui-col-md-12">
            <input type="text" class="layui-input" placeholder="查询员工姓名" autocomplete="off" id="search-emp">
        </div>
        <div class="layui-col-md-12" style="margin-top: 10px;">
            <ul class="employee-list" id="emp-list">
                {{# for (const emp of d.list) { }}
                    <li onclick="layui.chooseEmp({{ d.type }},{{ emp.id }},'{{ emp.name }}')">
                        <span>{{ emp.name }}</span>
                        <span>{{ emp.typeName }} </span>
                    </li>
                {{# } }}
            </ul>
        </div>
    </div>

</script>
<script>
    var form;
    layui.use('form', function(){
        form = layui.form;
    });
</script>
<script src="/js/xcity.js"></script>
<script>
    layui.use(['layer','form','laydate','laytpl'], function(){
        var layer = layui.layer;
        var form = layui.form;
        var laydate = layui.laydate;
        var laytpl = layui.laytpl;

        var type = getParamFromUrl('type');
        if(type == 'new'){
            $('#type').text('新建');
        }else{
            $('#type').text('编辑');
        }
        var projectId = getParamFromUrl('projectId');
        $('#projectId').val(projectId);

        $('#location').xcity();

        $.ajax({
            url: baseUrl + '/sidan/finance/project/info',
            type: 'get',
            data: {
                projectId: projectId
            },
            dataType: 'json',
            success: function(json){
                console.log(json);
                var project = json.info;
                $('#projectName').val(project.name);
                $('#projectNo').val(project.no);
                $('#contractNo').val(project.contractNo);
                $('#companyName').val(project.companyName);
                $('#groupName').val(project.groupName);
                $('#signDate').val(project.contractSignDate);
                $('#startDate').val(project.startDate);
                $('#endDate').val(project.endDate);
                $('#months').val(project.months);
                $('#totalPrice').val(project.totalPrice);
                $('#generalManager').val(project.generalManager);
                if(project.generalManagerId > 0){
                    var gm_html = '<div>' +
                                    '<span>' + project.generalManagerName + '</span>&nbsp;' +
                                    '<i class="layui-icon" onclick="layui.removeEmp(1)">&#x1006;</i>' +
                                '</div>';
                    $('#emp_gm').html(gm_html);
                }
                $('#manager').val(project.manager);
                if(project.managerId > 0){
                    var m_html = '<div>' +
                                    '<span>' + project.managerName + '</span>&nbsp;' +
                                    '<i class="layui-icon" onclick="layui.removeEmp(2)">&#x1006;</i>' +
                                '</div>';
                    $('#emp_m').html(m_html);
                }
                
                $('#location').xcity(project.province,project.city);
                var status = $('#status').children();
                for (var i = 0; i < status.length; i++) {
                    if (status[i].value == project.status) {
                        status[i].selected = true;
                    }
                }
                form.render();
            }
        })

        laydate.render({
            elem: '#signDate',
            trigger: 'click'//呼出事件改成click
        });
        laydate.render({
            elem: '#startDate',
            trigger: 'click',//呼出事件改成click
            done: function(value,date){
                countMonth();
            }
        });
        laydate.render({
            elem: '#endDate',
            trigger: 'click',//呼出事件改成click
            done: function(value,date){
                countMonth();
            }
        });

        function countMonth(){
            var startDate = $('#startDate').val();
            var endDate = $('#endDate').val();
            if(startDate != null && endDate != null){
                var start = new Date(startDate);
                var end = new Date(endDate);
                var startMs = start.getTime();
                var endMs = end.getTime();
                if(endMs > startMs){
                    var month = (endMs - startMs) / (1000 * 60 * 60 * 24) / 30;
                    console.log(month.toFixed(1));
                    $('#months').val(month.toFixed(1));
                }else{
                    $('#months').val(0);
                }
            }
        }

        form.on('submit(sub-project)', function(data){
            console.log(data);
            $.ajax({
                url:baseUrl + '/sidan/finance/project/add',
                type:'post',
                data:data.field,
                dataType:'json',
                success:function(json){
                    console.log(json);
                    if(json.code == 0){
                        layer.msg('保存成功');
                    }else{
                        layer.msg(json.msg);
                    }
                }
            });
            return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
        });

        $('#emp_gm').on('click',function(e){
            if(e.target.id != 'emp_gm'){
                return false;
            }
            var pos = e.target.getBoundingClientRect();
            var data = getEmpList();
            data.type = 1;
            //同步方式
            var tpl = laytpl($('#eList-tpl').html());
            var html = tpl.render(data);
            layer.closeAll();
            layer.open({
                type: 1,
                anim: 2,
                title: false,
                shadeClose: true,
                shade: false,
                resize: false,
                area: pos.width - 2 + 'px',
                offset: [pos.y + pos.height + 'px', pos.x + 'px'],
                content: html
            });

            var flag = false;
            $('#search-emp').on('input', function(){
                if(!flag){
                    renderEmpList(1);
                }
            }).on('compositionstart', function(){
                flag = true;//输入法，录入开始
            }).on('compositionend', function(){
                flag = false;//'输入法，输入结束'
                renderEmpList(1);
            });
            
        });

        $('#emp_m').on('click',function(e){
            if(e.target.id != 'emp_m'){
                return false;
            }
            var pos = e.target.getBoundingClientRect();
            var data = getEmpList();
            data.type = 2;
            //同步方式
            var tpl = laytpl($('#eList-tpl').html());
            var html = tpl.render(data);
            layer.closeAll();
            layer.open({
                type: 1,
                anim: 2,
                title: false,
                shadeClose: true,
                shade: false,
                resize: false,
                area: pos.width - 2 + 'px',
                offset: [pos.y + pos.height + 'px', pos.x + 'px'],
                content: html
            });

            var flag = false;
            $('#search-emp').on('input', function(){
                if(!flag){
                    renderEmpList(2);
                }
            }).on('compositionstart', function(){
                flag = true;//输入法，录入开始
            }).on('compositionend', function(){
                flag = false;//'输入法，输入结束'
                renderEmpList(2);
            });
            
        });

        layui.chooseEmp = function(type,id,name){
            console.log(id);
            var html = '<div>' +
                '<span>' + name + '</span>&nbsp;' +
                '<i class="layui-icon" onclick="layui.removeEmp(' + type + ')">&#x1006;</i>' +
                '</div>';
                
            if(type == 1){
                $('#generalManager').val(id);
                $('#emp_gm').html(html);
            }else{
                $('#manager').val(id);
                $('#emp_m').html(html);
            }
            layer.closeAll();
        }

        function getEmpList(){
            var data;
            $.ajax({
                url:baseUrl + '/sidan/finance/employee/list/all',
                type:'get',
                data: {
                    name: $('#search-emp').val()
                },
                dataType:'json',
                async: false,
                success:function(json){
                    console.log(json);
                    if(json.code == 0){
                        data = json;
                    }else{
                        layer.msg(json.msg);
                    }
                }
            });
            return data;
        }

        function renderEmpList(type){
            var data = getEmpList();
            var html = '';
            for (const emp of data.list) {
                html += [
                            '<li onclick="layui.chooseEmp(' + type + ',' + emp.id + ',\'' + emp.name + '\')">',
                                '<span>' + emp.name + '</span>',
                                '<span>' + emp.typeName + '</span>',
                            '</div>'
                        ].join('');
            }
            $('#emp-list').html(html);
        }

        layui.removeEmp = function(type){
            if(type == 1){
                $('#generalManager').val(-1);
                $('#emp_gm').html('');
            }else{
                $('#manager').val(-1);
                $('#emp_m').html('');
            }
        }

    });
</script>
</html>